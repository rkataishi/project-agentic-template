# Best Practices for Python Task Scripting with TOFA-WDF (v4.0)

This document presents a refined modular methodology for managing scripting projects using the **Task-Oriented Functional Architecture with Decoupled Flows (TOFA-WDF)**, complemented by the **Task Master** planning framework. It integrates a structured architecture of tasks, flows, and modules with a memory-based iterative pipeline, tracked in a dedicated `docs/pipeline/` folder.

## 1. Project Structure: Vertical Cohesion and Layered Separation

TOFA-WDF organizes all development around **capability-specific tasks**, with each task encapsulated as an autonomous directory. Logic is stratified across four distinct roles. Each task operates as an independent unit with its own logic, test samples, and documentation.

## 2. The Four-Tier Architecture

- **Scripts (`scripts/`)**: Located within each task, these receive CLI input and execute Orchestrators or Flows.
- **Flows (`flows/`)**: Residing at the project's root, these handle cross-task orchestration logic.
- **Orchestrators (`orchestrators/`)**: Found within a task's `functions/` directory, these sequence and manage `simple` functions (Modules) for a single task.
- **Modules (`simple/`)**: Also within a task's `functions/` directory, these are pure, atomic functional units.

```plaintext
project/
│   ├── data_processing/
│   │   ├── scripts/
│   │   │   └── process_csv.py
│   │   ├── functions/
│   │   │   ├── simple/
│   │   │   │   ├── load_data.py
│   │   │   │   ├── clean_data.py
│   │   │   │   └── validate_schema.py
│   │   │   └── orchestrators/
│   │   │       └── data_pipeline.py
│   │   └── test_data/
│   ├── automation/
│   ├── reporting/
│   └── ...
│
├── flows/
│   ├── data_flow.py
│   ├── report_flow.py
│   └── integration_flow.py
│
├── shared_modules/
│   ├── io/
│   ├── transformation/
│   ├── strings/
│   └── validation/
│
├── config/
│   └── config.py
│
├── tasks/
│   └── *.md                    # Task Master generated markdown files
│
├── docs/
│   ├── code_review_manual.md
│   ├── cross_task_coordination.md
│   ├── doc_guidelines.md
│   ├── test_data_policy.md
│   ├── rules/
│   │   ├── self_improve.md
│   │   ├── vscode_rules.md
│   │   └── knowledge_sync_policy.md
│   ├── pipeline/
│   │   ├── prd.md
│   │   ├── task_contract.md
│   │   ├── task-prd-revision.md
│   │   ├── microtasks.md
│   │   ├── microtasks_log.md
│   │   ├── microtasks_done/
│   │   ├── memories.md
│   │   └── learning_by_doing.md
│   │   ├── pipeline_development.md
│   │   ├── pipeline_pickup.md
│   │   ├── pipeline_tofa_wdf_overview.md
│   │   └── pipeline_workflow.md
│   └── templates/
│       ├── pipeline_template_learning_by_doing.md
│       ├── pipeline_template_memories.md
│       └── pipeline_template_task_contract.md
│
├── external_knowledge/
│   ├── selenium.md
│   ├── seaborn.md
│   ├── docs_task-master.md
│   └── task_master_integration.md
│   └── library_specs/
│
└── logs/
```

- The **`project/`** folder contains all task logic organized by operational goal.
- The **`docs/pipeline/`** folder is the reflexive memory system for planning, tracking, and documenting the lifecycle of development.
- The **`external_knowledge/`** folder is reserved for external documentation, library manuals, and technical API references.

## 3. Roles of Files in the Pipeline

- **`prd.md`**: High-level description of the task scope, objectives, hypotheses, and key steps (to be clarified per task).
- **`task_contract.md`**: Defines success criteria, input/output expectations, constraints, and test conditions.
- **`task-prd-revision.md`**: Logs changes and revisions to the PRD during implementation.
- **`microtasks.md`**: Contains the active subtask. Includes context, objective, plan, expected result, discovered constraints, implementation detail, and state.
- **`microtasks_log.md`**: Flat registry of completed microtasks (by ID and name), cross-referencing their `.md` files in `microtasks_done/`.
- **`microtasks_done/`**: Archive of completed microtasks in individual markdown files. The filename corresponds to the identifier used in the log.
- **`memories.md`**: Strategic and conceptual log of failures, discarded strategies, and validated decisions.
- **`learning_by_doing.md`**: Reflects on process improvements, workflow flaws, and long-term insights.

## 4. Directory Semantics
Here is the fully corrected version of Section 4: Directory Semantics, rewritten in English to match TOFA-WDF v4.0, which no longer uses tasks/ for source code.

⸻

4. Directory Semantics (TOFA-WDF v4.0)

TOFA-WDF has the convention of using all capabilities  organized directly at the root level (data_processing/, automation/, etc.). This frees up tasks/ to be reused for documentation or tooling outputs by task-master, without semantic conflict.

tasks/
	•	Reserved exclusively for autogenerated markdown files (e.g. from Task Master).
	•	Each .md file corresponds to a specification, PRD, or task-level description.
	•	No source code lives here.

data_processing/, automation/, reporting/, etc.
	•	Capability-specific folders containing implementation logic.
	•	Internal structure:
	•	scripts/ → CLI entry points.
	•	functions/orchestrators/ → Orchestrator functions sequencing modular steps.
	•	functions/simple/ → Atomic, stateless, reusable units.
	•	test_data/ → Local test samples for validation.

flows/
	•	Cross-task orchestration logic.
	•	Each file (e.g. data_flow.py, report_flow.py) coordinates pipelines involving multiple capabilities.

shared_modules/
	•	Centralized repository of general-purpose utilities.
	•	Organized by concern (io/, strings/, validation/, etc.).
	•	Importable by any task or flow.

config/
	•	Configuration logic: config.py, .env.sample, etc.
	•	Hosts parameter schemas, flags, environment toggles.

docs/
	•	All project documentation lives here.
	•	Subfolders include:
	•	pipeline/ → Strategic planning, memory logs, PRDs, microtasks.
	•	templates/ → Reusable templates for writing tasks.
	•	Optionally: docs/tasks/ → Symlinked or published copies of markdowns.

external_knowledge/
	•	Static references: external libraries, specs, manuals.
	•	Organized for long-term consultation.

logs/
	•	Runtime execution output, debugging info, crash logs.
	•	Optional subfolders per task.


### Compatibility with Task Master

No reconfiguration is required.
Using tasks/ as the output directory for task-master generate is fully compatible with TOFA-WDF v4.0 and no longer presents any structural or semantic conflict.

⸻


## 5. Conventions and Guarantees

- All folder and file names must be in English and lowercase.
- No script or flow may exist without an associated test and log.
- Every function (Module) is accompanied by a unit test written against a random sample of real data. Synthetic or handcrafted samples are not permitted.
- Every modification or failed strategy must be documented in `memories.md`.
- Every active task must be reflected in `microtasks.md` and archived upon completion.
- All configuration parameters (file paths, feature toggles, API keys) must be defined in `config/config.py`.
- Scripts and functions must not hardcode constants; they should reference `config.py`.
- All environment-sensitive values must be stored in a `.env` file and accessed via `os.getenv()` within `config.py`.
- `config/config.py` serves as the single source of truth for configuration across the system.

**State Management Standards:**
- All functions must be stateless and pure. Inputs and outputs must be passed explicitly via function arguments and return values.
- No function may rely on external variables, implicit context, or mutable shared state.
- Flows and orchestrators must clearly define the data interfaces between steps.
- Scripts and orchestrators must not use global variables to transfer data between phases.
- Intermediate results must be passed as return values or via defined data structures only.

**Dependency Management Practices:**
- All dependencies must be declared in a `requirements.txt` file at the root of the project.
- The project must be installable in a clean virtual environment using `pip install -r requirements.txt`.
- No module or script may depend on undeclared packages.
- Every task must document any new dependency introduced, and update the `requirements.txt` accordingly.

**Error handling:**
- All predictable errors must be handled within each function or module. Unexpected errors must be propagated upward and logged by orchestrators or flows.
- Scripts must wrap all execution entry points in try/except blocks and register exceptions using the project's logger (e.g., DualLogger or equivalent).
- Silent failure is prohibited: all exceptions must either be caught, traced, or escalated visibly.
- If a task fails due to runtime errors, the cause must be documented in `memories.md`, and the resolution path must be described in `learning_by_doing.md`.

- All scripts, flows, and orchestrators must use structured logging for traceability.
- The default logger is `DualLogger`, unless another is explicitly approved.
- Logs must be written to the `logs/` directory and support at least the following levels: INFO, WARNING, ERROR.
- Every execution must log:
  - Task start and completion (INFO)
  - Input and output file references (INFO)
  - Runtime exceptions (ERROR)
  - Validation failures (WARNING)
  - Key control flow decisions (INFO or DEBUG)
- No script should fail silently. Every error must be logged with traceback.
- No print statements in logic layers: use the logger instead.

## 6. Summary

This architecture:
- Separates roles with mathematical precision.
- Provides a formal memory and validation structure via the `docs/pipeline/` directory.
- Enables exact traceability of failures and successful design paths.
- Synchronizes tightly with Task Master while extending it with reflexive microtracking.

TOFA-WDF guarantees that technical development remains auditable, modular, and reversible. No part of the workflow exists without explanation. No decision exists without record. No script is ever developed without a plan, a purpose, and a trace.